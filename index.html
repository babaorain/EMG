<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMG tool</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --accent-light: #ebf5fb;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --bg: #f4f6f7;
            --card-bg: #ffffff;
            --border: #e0e0e0;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            color: #333;
        }

        h1 { text-align: center; color: var(--primary); margin: 10px 0 5px 0; }
        p.subtitle { text-align: center; color: #7f8c8d; margin-top: 0; margin-bottom: 25px; font-size: 0.9rem;}

        /* --- Navigation --- */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 8px;
            border-radius: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .mode-btn {
            padding: 8px 24px;
            background: transparent;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            color: #7f8c8d;
            transition: 0.2s;
            font-size: 0.95rem;
        }
        .mode-btn:hover { color: var(--primary); background: #f0f2f5; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 3px 8px rgba(44, 62, 80, 0.3); }

        /* --- Containers --- */
        .view-container { display: none; animation: fadeIn 0.3s; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(5px); } to { opacity:1; transform: translateY(0); } }

        /* --- DIAGNOSIS BOARD LAYOUT --- */
        .diag-grid {
            display: grid;
            grid-template-columns: 45% 55%; /* Left side wider now for the picker */
            gap: 25px;
            align-items: start;
        }
        @media (max-width: 900px) { .diag-grid { grid-template-columns: 1fr; } }

        .panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; display: inline-block; font-size: 1.1rem; margin-bottom: 15px; }

        /* --- LEFT PANEL: SMART PICKER --- */
        .filter-section { margin-bottom: 15px; }
        .filter-label { font-size: 0.8rem; font-weight: bold; color: #999; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px;}

        .chip-container { display: flex; flex-wrap: wrap; gap: 6px; }

        .filter-chip {
            font-size: 0.85rem; padding: 5px 12px; border-radius: 15px;
            border: 1px solid var(--border); background: white; color: #666;
            cursor: pointer; transition: 0.2s; user-select: none;
        }
        .filter-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3); }

        .search-box {
            width: 100%; padding: 10px 15px;
            border: 2px solid var(--border); border-radius: 8px;
            font-size: 1rem; margin-bottom: 15px; box-sizing: border-box;
        }
        .search-box:focus { border-color: var(--accent); outline: none; }

        /* Candidate List (The Cloud) */
        .candidate-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px; overflow-y: auto; max-height: 400px; padding: 5px;
        }

        .candidate-btn {
            background: white; border: 1px solid var(--border);
            border-radius: 6px; padding: 8px; text-align: left;
            cursor: pointer; transition: 0.2s; position: relative;
            display: flex; flex-direction: column; justify-content: center;
        }
        .candidate-btn:hover { border-color: var(--accent); background: var(--accent-light); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .candidate-btn:active { transform: translateY(0); }

        .cand-name { font-weight: 600; font-size: 0.9rem; color: #2c3e50; line-height: 1.2; margin-bottom: 4px; }
        .cand-meta { font-size: 0.75rem; color: #7f8c8d; }

        /* --- RIGHT PANEL: EXAM & DIAGNOSIS --- */
        .exam-list { flex-grow: 1; margin-bottom: 20px; overflow-y: auto; max-height: 400px; }

        .exam-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; margin-bottom: 8px;
            background: white; border: 1px solid var(--border); border-radius: 8px;
            border-left: 6px solid #bdc3c7; cursor: pointer; transition: 0.2s;
        }
        .exam-item:hover { background: #fafafa; }

        .exam-item.abnormal { border-left-color: var(--danger); background: #fff5f5; border-color: #feb2b2; }
        .exam-item.normal { border-left-color: var(--success); background: #f0fff4; border-color: #9ae6b4; }

        .exam-info { flex-grow: 1; }
        .exam-name { font-weight: 700; font-size: 1rem; color: #2d3748; display:block;}
        .exam-meta { font-size: 0.85rem; color: #718096; }

        .btn-remove {
            background: none; border: none; color: #ccc; font-size: 1.5rem;
            cursor: pointer; padding: 0 0 0 15px; line-height: 1;
        }
        .btn-remove:hover { color: var(--danger); }

        /* Analysis Result Box */
        .analysis-box { border-top: 2px solid #eee; padding-top: 20px; }
        .lesion-card {
            background: #f8f9fa; padding: 15px; margin-bottom: 10px;
            border-radius: 8px; border-left: 5px solid var(--primary);
        }
        .lesion-high-prob { background: #fff8e1; border-left-color: #ffc107; color: #5d4037; }
        .lesion-ruled-out { background: #f1f1f1; border-left-color: #bdc3c7; color: #7f8c8d; opacity: 0.7; }
        .lesion-warning { background: #fff3e0; border-left-color: var(--warning); }

        /* --- Tree Styles (for reference tabs) --- */
        #upper, #lower { max-width: 1000px; margin: 0 auto; }
        details { margin: 8px 0; background: white; border-radius: 6px; border: 1px solid #eee; overflow: hidden; }
        summary { cursor: pointer; padding: 10px 15px; font-weight: 600; background: #fff; display: flex; justify-content: space-between; }
        summary:hover { background: #f9fafb; }
        .content { padding: 10px; }

        .lvl-root > summary { border-left: 5px solid var(--danger); color: #c0392b; }
        .lvl-trunk > summary { border-left: 5px solid var(--warning); color: #d35400; }
        .lvl-cord > summary { border-left: 5px solid #9b59b6; color: #8e44ad; }
        .lvl-nerve > summary { border-left: 5px solid var(--accent); color: #2980b9; }

        .muscle-tag {
            display: inline-block; background: #e6fffa; color: #2c7a7b;
            padding: 3px 8px; margin: 2px; border-radius: 4px; font-size: 0.85rem; border: 1px solid #b2f5ea;
        }

    </style>
</head>
<body>

    <h1>EMG tool</h1>
    <p class="subtitle">å°å·¥å…·</p>

    <div class="nav-bar">
        <button class="mode-btn active" onclick="switchView('diagnosis')">è¨ºæ–·ç™½æ¿ (Diagnosis)</button>
        <button class="mode-btn" onclick="switchView('upper')">Upper Limb Tree</button>
        <button class="mode-btn" onclick="switchView('lower')">Lower Limb Tree</button>
    </div>

    <div id="diagnosis" class="view-container active">
        <div class="diag-grid">

            <div class="panel">
                <h3>Muscle Picker (å¿«é€Ÿé¸æ“‡)</h3>

                <input type="text" class="search-box" id="smartSearch" placeholder="è¼¸å…¥åç¨±æœå°‹ (ä¾‹å¦‚: FDI, Deltoid)..." onkeyup="renderCandidates()">

                <div class="filter-section">
                    <span class="filter-label">By Root (é»æ“Šç¯©é¸):</span>
                    <div class="chip-container" id="rootFilters">
                        </div>
                </div>
                <div class="filter-section">
                    <span class="filter-label">By Nerve:</span>
                    <div class="chip-container" id="nerveFilters">
                        </div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">

                <div class="filter-label">é»æ“ŠåŠ å…¥æª¢æŸ¥åˆ—è¡¨:</div>
                <div id="candidateList" class="candidate-grid">
                    </div>
            </div>

            <div class="panel">

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3>Exam Findings (æª¢æŸ¥çµæœ)</h3>
                    <button onclick="clearExam()" style="font-size:0.85rem; color:#e74c3c; background:none; border:1px solid #e74c3c; padding:4px 10px; border-radius:4px; cursor:pointer;">Clear All</button>
                </div>

                <p style="font-size:0.8rem; color:#999; margin-top:-10px; margin-bottom:15px;">é»æ“Šåˆ‡æ›: âšªæœªå®š â ğŸ”´ç•°å¸¸ â ğŸŸ¢æ­£å¸¸</p>

                <div id="examList" class="exam-list">
                    <div style="text-align:center; color:#ccc; padding-top:50px;">
                        å°šæœªåŠ å…¥è‚Œè‚‰ã€‚<br>è«‹å¾å·¦å´é»æ“ŠåŠ å…¥ã€‚
                    </div>
                </div>

                <div class="analysis-box">
                    <h3>Diagnostic Logic (è‡ªå‹•åˆ†æ)</h3>
                    <div id="analysisResult">
                        <div style="color:#999; font-size:0.9rem;">ç­‰å¾…è³‡æ–™...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="upper" class="view-container"></div>
    <div id="lower" class="view-container"></div>

<script>
    // --- ENRICHED DATABASE (v7.0) ---
    // Added missing muscles from Image Logic: Subclavius, Subscapularis, Teres Major, Gemelli, Obturator Int, Quadratus Fem, Piriformis
    const db = [
        // Upper Limb
        {"m": "Rhomboid Major/Minor", "n": "Dorsal Scapular N.", "r": "C5", "r_list": ["C5"]},
        {"m": "Levator Scapulae", "n": "Dorsal Scapular N.", "r": "C3-C5", "r_list": ["C3","C4","C5"]},
        {"m": "Serratus Anterior", "n": "Long Thoracic N.", "r": "C5-C7", "r_list": ["C5","C6","C7"]},
        {"m": "Subclavius", "n": "N. to Subclavius", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Supraspinatus", "n": "Suprascapular N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Infraspinatus", "n": "Suprascapular N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Pectoralis Major (Clavicular)", "n": "Lateral Pectoral N.", "r": "C5-C7", "r_list": ["C5","C6","C7"]},
        {"m": "Pectoralis Major (Sternal)", "n": "Medial Pectoral N.", "r": "C8-T1", "r_list": ["C8","T1"]},
        {"m": "Pectoralis Minor", "n": "Medial Pectoral N.", "r": "C8-T1", "r_list": ["C8","T1"]},
        {"m": "Subscapularis", "n": "Subscapular N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Teres Major", "n": "Lower Subscapular N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Latissimus Dorsi", "n": "Thoracodorsal N.", "r": "C6-C8", "r_list": ["C6","C7","C8"]},
        {"m": "Deltoid", "n": "Axillary N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Teres Minor", "n": "Axillary N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Biceps Brachii", "n": "Musculocutaneous N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Brachialis", "n": "Musculocutaneous N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "Coracobrachialis", "n": "Musculocutaneous N.", "r": "C5-C7", "r_list": ["C5","C6","C7"]},
        {"m": "Triceps", "n": "Radial N.", "r": "C6-C8", "r_list": ["C6","C7","C8"]},
        {"m": "Anconeus", "n": "Radial N.", "r": "C6-C8", "r_list": ["C6","C7","C8"]},
        {"m": "Brachioradialis", "n": "Radial N.", "r": "C5-C6", "r_list": ["C5","C6"]},
        {"m": "ECRL / ECRB", "n": "Radial N.", "r": "C6-C7", "r_list": ["C6","C7"]},
        {"m": "Supinator", "n": "PIN (Radial)", "r": "C6-C7", "r_list": ["C6","C7"]},
        {"m": "EDC (Extensor Digitorum)", "n": "PIN (Radial)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "ECU (Extensor Carpi Ulnaris)", "n": "PIN (Radial)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "EIP (Extensor Indicis)", "n": "PIN (Radial)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "EPL / EPB / APL", "n": "PIN (Radial)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "Pronator Teres", "n": "Median N.", "r": "C6-C7", "r_list": ["C6","C7"]},
        {"m": "FCR", "n": "Median N.", "r": "C6-C7", "r_list": ["C6","C7"]},
        {"m": "Palmaris Longus", "n": "Median N.", "r": "C7-T1", "r_list": ["C7","C8","T1"]},
        {"m": "FDS", "n": "Median N.", "r": "C7-T1", "r_list": ["C7","C8","T1"]},
        {"m": "FPL", "n": "AIN (Median)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "FDP (2,3)", "n": "AIN (Median)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "Pronator Quadratus", "n": "AIN (Median)", "r": "C7-C8", "r_list": ["C7","C8"]},
        {"m": "APB / OP / FPB", "n": "Median N.", "r": "C8-T1", "r_list": ["C8","T1"]},
        {"m": "Lumbricals (1,2)", "n": "Median N.", "r": "C8-T1", "r_list": ["C8","T1"]},
        {"m": "FCU", "n": "Ulnar N.", "r": "C8-T1", "r_list": ["C8","T1"]},
        {"m": "FDP (4,5)", "n": "Ulnar N.", "r": "C8-T1", "r_list": ["C8","T1"]},
        {"m": "FDI / ADM / Interossei", "n": "Ulnar N.", "r": "C8-T1", "r_list": ["C8","T1"]},

        // Lower Limb
        {"m": "Iliopsoas", "n": "Femoral N.", "r": "L1-L3", "r_list": ["L1","L2","L3"]},
        {"m": "Quadriceps", "n": "Femoral N.", "r": "L2-L4", "r_list": ["L2","L3","L4"]},
        {"m": "Sartorius", "n": "Femoral N.", "r": "L2-L3", "r_list": ["L2","L3"]},
        {"m": "Pectineus", "n": "Femoral N.", "r": "L2-L3", "r_list": ["L2","L3"]},
        {"m": "Adductor Longus/Brevis", "n": "Obturator N.", "r": "L2-L4", "r_list": ["L2","L3","L4"]},
        {"m": "Adductor Magnus", "n": "Obturator N.", "r": "L2-L4", "r_list": ["L2","L3","L4"]},
        {"m": "Gracilis", "n": "Obturator N.", "r": "L2-L4", "r_list": ["L2","L3","L4"]},
        {"m": "Obturator Externus", "n": "Obturator N.", "r": "L3-L4", "r_list": ["L3","L4"]},
        {"m": "Gluteus Medius/Minimus", "n": "Superior Gluteal N.", "r": "L4-S1", "r_list": ["L4","L5","S1"]},
        {"m": "Tensor Fasciae Latae", "n": "Superior Gluteal N.", "r": "L4-S1", "r_list": ["L4","L5","S1"]},
        {"m": "Gluteus Major", "n": "Inferior Gluteal N.", "r": "L5-S2", "r_list": ["L5","S1","S2"]},
        {"m": "Piriformis", "n": "Sacral Plexus (Direct)", "r": "S1-S2", "r_list": ["S1","S2"]},
        {"m": "Obturator Internus / Gemelli", "n": "Sacral Plexus (Direct)", "r": "L5-S1", "r_list": ["L5","S1"]},
        {"m": "Quadratus Femoris", "n": "Sacral Plexus (Direct)", "r": "L4-S1", "r_list": ["L4","L5","S1"]},
        {"m": "Semitendinosus", "n": "Sciatic (Tibial)", "r": "L5-S2", "r_list": ["L5","S1","S2"]},
        {"m": "Semimembranosus", "n": "Sciatic (Tibial)", "r": "L5-S2", "r_list": ["L5","S1","S2"]},
        {"m": "Biceps Femoris (Long)", "n": "Sciatic (Tibial)", "r": "L5-S2", "r_list": ["L5","S1","S2"]},
        {"m": "Biceps Femoris (Short)", "n": "Sciatic (Peroneal)", "r": "L5-S1", "r_list": ["L5","S1"]},
        {"m": "Tibialis Anterior", "n": "Deep Peroneal N.", "r": "L4-L5", "r_list": ["L4","L5"]},
        {"m": "EHL / EDL", "n": "Deep Peroneal N.", "r": "L5-S1", "r_list": ["L5","S1"]},
        {"m": "EHB / EDB", "n": "Deep Peroneal N.", "r": "L5-S1", "r_list": ["L5","S1"]},
        {"m": "Peroneus Longus/Brevis", "n": "Superficial Peroneal N.", "r": "L5-S1", "r_list": ["L5","S1"]},
        {"m": "Gastrocnemius", "n": "Tibial N.", "r": "S1-S2", "r_list": ["S1","S2"]},
        {"m": "Soleus", "n": "Tibial N.", "r": "S1-S2", "r_list": ["S1","S2"]},
        {"m": "Popliteus", "n": "Tibial N.", "r": "L4-S1", "r_list": ["L4","L5","S1"]},
        {"m": "Tibialis Posterior", "n": "Tibial N.", "r": "L4-L5", "r_list": ["L4","L5"]},
        {"m": "FDL / FHL", "n": "Tibial N.", "r": "L5-S2", "r_list": ["L5","S1","S2"]},
        {"m": "Foot Intrinsics (AH, FDB)", "n": "Plantar N. (Tibial)", "r": "S1-S2", "r_list": ["S1","S2"]}
    ];

    // Sorting DB
    db.sort((a,b) => a.m.localeCompare(b.m));

    // --- GLOBAL STATE ---
    let examData = [];
    let activeRootFilter = null;
    let activeNerveFilter = null;

    // --- INITIALIZATION ---
    const roots = ["C5","C6","C7","C8","T1","L2","L3","L4","L5","S1","S2"];
    const nerves = ["Median","Ulnar","Radial","Axillary","Musculo","Femoral","Obturator","Sciatic","Peroneal","Tibial"];

    window.onload = function() {
        // 1. Build Filter Chips
        const rCont = document.getElementById('rootFilters');
        roots.forEach(r => {
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerText = r;
            chip.onclick = () => setRootFilter(r, chip);
            rCont.appendChild(chip);
        });

        const nCont = document.getElementById('nerveFilters');
        nerves.forEach(n => {
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerText = n;
            chip.onclick = () => setNerveFilter(n, chip);
            nCont.appendChild(chip);
        });

        // 2. Initial Candidate Render (All)
        renderCandidates();

        // 3. Render Trees
        renderTree('upper');
        renderTree('lower');
    };

    // --- PICKER LOGIC ---
    function setRootFilter(root, el) {
        if (activeRootFilter === root) {
            activeRootFilter = null;
            el.classList.remove('active');
        } else {
            activeRootFilter = root;
            document.querySelectorAll('#rootFilters .filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }
        renderCandidates();
    }

    function setNerveFilter(nerve, el) {
        if (activeNerveFilter === nerve) {
            activeNerveFilter = null;
            el.classList.remove('active');
        } else {
            activeNerveFilter = nerve;
            document.querySelectorAll('#nerveFilters .filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }
        renderCandidates();
    }

    function renderCandidates() {
        const container = document.getElementById('candidateList');
        const search = document.getElementById('smartSearch').value.toLowerCase();
        container.innerHTML = '';

        const filtered = db.filter(item => {
            // Search Text
            if (search && !item.m.toLowerCase().includes(search) && !item.n.toLowerCase().includes(search)) return false;
            // Root Filter
            if (activeRootFilter && !item.r_list.includes(activeRootFilter)) return false;
            // Nerve Filter
            if (activeNerveFilter && !item.n.toLowerCase().includes(activeNerveFilter.toLowerCase())) return false;

            return true;
        });

        if(filtered.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#ccc; padding:20px;">æŸ¥ç„¡è‚Œè‚‰</div>';
            return;
        }

        filtered.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'candidate-btn';
            btn.innerHTML = `<span class="cand-name">${item.m}</span><span class="cand-meta">${item.r}</span>`;
            btn.onclick = () => addExamItem(item);
            container.appendChild(btn);
        });
    }

    // --- EXAM & DIAGNOSIS LOGIC ---
    function addExamItem(item) {
        const uniqueId = item.m + item.n;
        if(examData.find(e => (e.data.m + e.data.n) === uniqueId)) return; // No duplicates

        examData.push({ data: item, status: 0 });
        renderExamList();
        // Clear search but keep filters?
        // Usually better to keep workflow fluid, so don't reset filters yet.
    }

    function toggleStatus(index) {
        examData[index].status = (examData[index].status + 1) % 3;
        renderExamList();
        runAnalysis();
    }

    function removeExamItem(index, e) {
        e.stopPropagation();
        examData.splice(index, 1);
        renderExamList();
        runAnalysis();
    }

    function clearExam() {
        examData = [];
        renderExamList();
        runAnalysis();
    }

    function renderExamList() {
        const container = document.getElementById('examList');
        container.innerHTML = '';

        if(examData.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#ccc; padding-top:50px;">å°šæœªåŠ å…¥è‚Œè‚‰ã€‚<br>è«‹å¾å·¦å´é»æ“ŠåŠ å…¥ã€‚</div>';
            return;
        }

        examData.forEach((item, idx) => {
            const m = item.data;
            const div = document.createElement('div');
            let statusClass = '';
            let statusText = 'âšª æœªå®š';

            if(item.status === 1) { statusClass = 'abnormal'; statusText = 'ğŸ”´ ç•°å¸¸'; }
            if(item.status === 2) { statusClass = 'normal'; statusText = 'ğŸŸ¢ æ­£å¸¸'; }

            div.className = `exam-item ${statusClass}`;
            div.onclick = () => toggleStatus(idx);
            div.innerHTML = `
                <div class="exam-info">
                    <span class="exam-name">${m.m}</span>
                    <span class="exam-meta">${m.n} (${m.r})</span>
                </div>
                <span style="font-size:0.8rem; font-weight:bold; margin-right:10px;">${statusText}</span>
                <button class="btn-remove" onclick="removeExamItem(${idx}, event)">Ã—</button>
            `;
            container.appendChild(div);
        });
    }

    function runAnalysis() {
        const container = document.getElementById('analysisResult');
        const abnormal = examData.filter(e => e.status === 1);
        const normal = examData.filter(e => e.status === 2);

        if (abnormal.length === 0 && normal.length === 0) {
            container.innerHTML = '<div style="color:#999;">ç­‰å¾…è³‡æ–™...</div>';
            return;
        }
        if (abnormal.length === 0) {
            container.innerHTML = '<div class="lesion-card"><h4 style="margin:0 0 5px 0;">ğŸŸ¢ Normal Study</h4>æ‰€æœ‰æ¸¬è©¦è‚Œè‚‰çš†æ­£å¸¸ã€‚</div>';
            return;
        }

        // Logic
        let rootCounts = {};
        let nerveCounts = {};

        abnormal.forEach(item => {
            const info = item.data;
            info.r_list.forEach(r => rootCounts[r] = (rootCounts[r] || 0) + 1);
            nerveCounts[info.n] = (nerveCounts[info.n] || 0) + 1;
        });

        let likelyRoots = Object.keys(rootCounts).filter(r => rootCounts[r] === abnormal.length);
        let likelyNerves = Object.keys(nerveCounts).filter(n => nerveCounts[n] === abnormal.length);

        let ruledOutRoots = [];
        let confirmedRoots = [];

        likelyRoots.forEach(root => {
            const abnormalNerves = new Set(abnormal.map(a => a.data.n));
            const contradiction = normal.find(nItem => {
                const nInfo = nItem.data;
                if (!nInfo.r_list.includes(root)) return false;
                return !abnormalNerves.has(nInfo.n);
            });

            if (contradiction) {
                ruledOutRoots.push({
                    root: root,
                    reason: `ä½† <strong>${contradiction.data.m}</strong> (${contradiction.data.n}) æ˜¯æ­£å¸¸çš„ã€‚`
                });
            } else {
                confirmedRoots.push(root);
            }
        });

        let html = '';
        if(likelyNerves.length > 0) {
             html += `<div class="lesion-card lesion-high-prob"><h4 style="margin:0 0 5px 0;">ğŸ”´ Peripheral Nerve?</h4><p style="margin:0;">ç¬¦åˆæ¨¡å¼: <strong>${likelyNerves.join(", ")}</strong></p></div>`;
        }
        if(confirmedRoots.length > 0) {
             html += `<div class="lesion-card lesion-high-prob"><h4 style="margin:0 0 5px 0;">ğŸ”´ Radiculopathy?</h4><p style="margin:0;">é«˜åº¦æ‡·ç–‘ Root: <strong>${confirmedRoots.join(", ")}</strong></p></div>`;
        }
        if(ruledOutRoots.length > 0) {
            html += `<div class="lesion-card lesion-ruled-out"><h4 style="margin:0 0 5px 0;">âŒ æ’å‡ºçš„ Root (Ruled Out)</h4>${ruledOutRoots.map(item => `<p style="font-size:0.85rem; margin-bottom:5px;"><strong>${item.root}</strong> ç¬¦åˆç•°å¸¸ï¼Œ<br>${item.reason}</p>`).join("")}</div>`;
        }
        if(confirmedRoots.length === 0 && likelyNerves.length === 0 && ruledOutRoots.length === 0) {
             const possibleRoots = Object.keys(rootCounts).filter(r => rootCounts[r] > 0);
             possibleRoots.sort((a,b) => rootCounts[b] - rootCounts[a]);
             html += `<div class="lesion-card lesion-warning"><h4 style="margin:0 0 5px 0;">ğŸŸ  æ··åˆå‹ / å¤šç¯€ç—…è®Š?</h4><p style="margin:0; font-size:0.9rem;">ç„¡å–®ä¸€è§£é‡‹ã€‚Top Hits: ${possibleRoots.map(r => `${r}(${rootCounts[r]})`).join(", ")}</p></div>`;
        }
        container.innerHTML = html;
    }

    // --- VIEW SWITCHER ---
    function switchView(id) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.mode-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- TREE RENDERERS (Static Structure based on Image) ---
    function renderTree(type) {
        const container = document.getElementById(type);
        if(container.innerHTML.trim() !== "") return;

        const structure = (type === 'upper') ? [
            { level: 'root', name: 'C5 Root', items: [{name:'Dorsal Scapular N.', key:'Dorsal Scapular', muscles:['Rhomboid','Levator']}]},
            { level: 'root', name: 'Roots C5-7', items: [{name:'Long Thoracic N.', key:'Long Thoracic', muscles:['Serratus']}]},
            { level: 'trunk', name: 'Upper Trunk', items: [{name:'Suprascapular N.', key:'Suprascapular', muscles:['Supra','Infra']}, {name:'N. to Subclavius', key:'Subclavius', muscles:['Subclavius']}]},
            { level: 'cord', name: 'Lateral Cord', items: [{name:'Lat. Pectoral N.', key:'Lat', muscles:['Pectoralis Major']}, {name:'Musculocutaneous N.', key:'Musculo', muscles:['Biceps','Brachialis','Coraco']}]},
            { level: 'cord', name: 'Posterior Cord', items: [{name:'Subscapular N.', key:'Subscap', muscles:['Subscap','Teres Major']}, {name:'Thoracodorsal N.', key:'Thora', muscles:['Latissimus']}, {name:'Axillary N.', key:'Axillary', muscles:['Deltoid','Teres Minor']}, {name:'Radial N.', key:'Radial', muscles:['Triceps','Anconeus','Brachioradialis','Supinator','Extensor']}]},
            { level: 'cord', name: 'Medial Cord', items: [{name:'Med. Pectoral N.', key:'Medial Pec', muscles:['Pectoralis Minor']}, {name:'Ulnar N.', key:'Ulnar', muscles:['FCU','FDP','FDI','ADM']}]},
            { level: 'nerve', name: 'Median N.', items: [{name:'Median N.', key:'Median', muscles:['Pronator','FCR','FDS','FPL','APB']}]}
        ] : [
            { level: 'trunk', name: 'Lumbar Plexus', items: [{name:'Femoral N.', key:'Femoral', muscles:['Iliopsoas','Quad','Sartorius']}, {name:'Obturator N.', key:'Obturator', muscles:['Adductor','Gracilis']}]},
            { level: 'trunk', name: 'Sacral Plexus', items: [
                {name:'Sup. Gluteal N.', key:'Superior Gluteal', muscles:['Gluteus Med','Tensor']},
                {name:'Inf. Gluteal N.', key:'Inferior Gluteal', muscles:['Gluteus Maj']},
                {name:'Sciatic (Tibial)', key:'Sciatic', muscles:['Semi','Biceps Femoris (Long)']},
                {name:'Sciatic (Peroneal)', key:'Sciatic', muscles:['Biceps Femoris (Short)']},
                {name:'Deep Peroneal N.', key:'Deep', muscles:['Tibialis Ant','EHL','EDL']},
                {name:'Sup. Peroneal N.', key:'Superficial', muscles:['Peroneus']},
                {name:'Tibial N.', key:'Tibial', muscles:['Gastroc','Soleus','Popliteus','Tibialis Post']}
            ]}
        ];

        let html = '<div class="panel" style="max-width:900px; margin:0 auto;">';
        structure.forEach(block => {
            let content = "";
            block.items.forEach(n => {
                // Find Muscles
                let matches = [];
                let seen = new Set();
                db.forEach(m => {
                    let match = false;
                    if(n.muscles) n.muscles.forEach(k => { if(m.m.toLowerCase().includes(k.toLowerCase())) match = true; });
                    if(match && !seen.has(m.m)) { matches.push(m); seen.add(m.m); }
                });

                if(matches.length > 0) {
                    content += `<div style="margin-bottom:8px; border:1px solid #eee; border-radius:4px; overflow:hidden;">
                        <div style="background:#f7f9fc; padding:5px 10px; font-weight:bold; font-size:0.85rem;">${n.name}</div>
                        <div style="padding:5px;">${matches.map(m=>`<span class="muscle-tag">${m.m} <span style="font-size:0.75em; color:#777;">(${m.r})</span></span>`).join('')}</div>
                    </div>`;
                }
            });

            if(content) {
                html += `<details class="lvl-${block.level}"><summary>${block.name}</summary><div class="content">${content}</div></details>`;
            }
        });
        html += '</div>';
        container.innerHTML = html;
    }
</script>
</body>
</html>
